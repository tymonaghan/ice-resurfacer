<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css" />

    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>Ice Resurfacer 2000</h1>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
          default: "arcade",
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      var cursors;
      var player;
      var scuffs;
      var score;
      var scoreText;
      var time;
      var timeDisplay;
      var boards;
      var currentRinkName;
      var gameOver = false;
      var win = false;

      var game = new Phaser.Game(config);

      function preload() {
        // this.load.setBaseURL('http://labs.phaser.io');

        this.load.image("rink", "assets/rink2.png");
        this.load.image("resurfacer", "assets/resurfacer.png");
        this.load.image("scuff", "assets/scuff.png");
        this.load.image("boards", "assets/boards.png");
        this.load.image("wall", "assets/platform.png");
      }

      function create() {
        //boards (write under the rink so they're invisible)
        boards = this.physics.add.staticGroup();
        // boards.create(400, 300, 'boards');
        boards.create(400, 72, "wall").setScale(2).refreshBody();
        boards.create(400, 590, "wall").setScale(2).refreshBody();
        boards.create(15, 350, "wall").setScale(2).setAngle(90).refreshBody();
        boards.create(780, 350, "wall").setScale(2).setAngle(90).refreshBody();

        // rink
        this.add.image(400, 300, "rink");
        // scuffs
        scuffs = this.physics.add.group({
          key: "scuff",
          repeat: 50,
          setXY: {
            x: 75,
            y: 150,
            stepX: 10,
          },
        });
        scuffs.children.iterate(function (child) {
          child.x = Phaser.Math.Between(100, 700);
          child.y = Phaser.Math.Between(115, 500);
        });

        // player / ice resurfacer
        player = this.physics.add.sprite(300, 200, "resurfacer").setScale(1.5);
        player.setBounce(0.1);
        player.setDamping(true);
        player.setDrag(0.38);
        player.setCollideWorldBounds(true);

        //  Input Events
        cursors = this.input.keyboard.createCursorKeys();

        // collisions/ pickups
        this.physics.add.overlap(player, scuffs, cleanScuff, null, this);
        this.physics.add.collider(player, boards);
        // not sure why i'm not colliding with the boards here

        // scoreboard and timer
        score = 0;
        scoreText = this.add.text(15, 15, "Score: 0", {
          fontSize: "32px",
          fill: "#ffffff",
        });

        time = 0;
        timeDisplay = this.add.text(15, 40, "Time: 0", {
          fontSize: "32px",
          fill: "#ffffff",
        });

        currentRinkName = this.add.text(
          380,
          15,
          "Current Rink:\nVillage Grove Park District",
          {
            align: "right",
            fontSize: "24px",
            fill: "#ffffff",
          }
        );
      }

      function update() {
        var up;

        if (player.angle > 0) up = true;
        if (player.angle < 0) up = false;

        if (cursors.left.isDown) {
          player.setAngle(player.angle - player.body.speed * 0.03);
        } else if (cursors.right.isDown) {
          player.setAngle(player.angle + player.body.speed * 0.03);
        } else if (cursors.up.isDown) {
          player.setVelocityX(Math.abs(player.angle) - 90);
          player.setVelocityY(
            // translating angle into x and y velocities sucks
            Math.abs(player.angle) < 180 - Math.abs(player.angle)
              ? up
                ? -Math.abs(player.angle) // going up and right
                : Math.abs(player.angle) // going down and right
              : up
              ? -180 + Math.abs(player.angle) // going up and left
              : 180 - Math.abs(player.angle) // going down and left
          );
        }
        time = Phaser.Math.FloorTo(
          this.sys.game.loop.time.toString() / 1000,
          0
        );
        if (time > 99) {
          gameOver = true;
        }

        if (!gameOver) {
          timeDisplay.setText("Time: " + time);
        }

        if (gameOver) {
          this.physics.pause();
          if (win) {
            this.add.text(400, 300, "You did it!", {
              fontSize: "32px",
              fill: "#ffffff",
            });
          } else {
            this.add.text(400, 300, "You're fired!", {
              fontSize: "32px",
              fill: "#ffffff",
            });
          }
        }
      }

      function cleanScuff(player, scuff) {
        scuff.disableBody(true, true);

        score += 1;
        scoreText.setText("Score: " + score);

        if (scuffs.countActive(true) === 0) {
          win = true;
          //  when all scuffs are collected, game over man, game over.
          // make the resurfacer sparkle all the time because why not
          var particles = this.add.particles("red");
          var emitter = particles.createEmitter({
            speed: 100,
            scale: { start: 1, end: 0 },
            blendMode: "ADD",
          });
          emitter.startFollow(player);
          this.physics.pause();
          gameOver = true;
        }
      }
    </script>
    <p>
      made with
      <a href="https://photonstorm.github.io/phaser3-docs/index.html"
        >Phaser 3</a
      >
      by <a href="https://tylermonaghan.dev">Tyler Monaghan</a>
      |
      <a href="https://github.com/tymonaghan/ice-resurfacer">view on GitHub</a>
    </p>
  </body>
</html>
